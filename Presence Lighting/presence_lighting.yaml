blueprint:
  name: Presence Lighting
  description: >
    Turns lights on and off based on room presence. Supports customizable
    turn-on/off actions, alternate delays (for guests or nighttime), sleeping
    child suppression, upstairs lighting timer checks, and arbitrary custom
    conditions via templates.

    Note: Lights will never turn on for a room whose presence state is
    sleeping (Going to Sleep, Sleeping, Waking Up), because the turn-on
    branch requires a transition from an unoccupied state (Empty, Extended
    Away, Unknown) to an occupied state. Sleeping states are not unoccupied,
    so they cannot produce that transition.
  domain: automation
  input:
    # ========== Room Setup ==========
    room_presence_entity:
      name: Room presence entity
      description: >
        The input_select entity that tracks room presence
        (e.g., input_select.presence_garage).
      selector:
        entity:
          domain: input_select

    room_presence_trigger_mode:
      name: Room presence trigger mode
      description: >
        Controls whether the room presence entity triggers the turn-on
        branch, the turn-off branch, both, or neither.

        - Both (default): Room presence changes trigger both turn-on and
          turn-off logic.
        - Detect only: Room presence triggers turn-on but not turn-off.
          Use for rooms where a separate sensor handles clearing.
        - Clear only: Room presence triggers turn-off but not turn-on.
          Use for rooms like the Hallway where a sensor detects presence
          but room presence handles the off transition.
        - Neither: Room presence does not trigger any lighting action.
          Use for rooms like Stairs or Front Room Lamps where only
          additional sensors drive the lights. The room presence entity
          is still used as a condition to check occupancy state.
      default: both
      selector:
        select:
          options:
            - label: Both
              value: both
            - label: Detect only
              value: detect_only
            - label: Clear only
              value: clear_only
            - label: Neither
              value: neither

    light_entity_to_check:
      name: Primary light entity to check
      description: >
        The main light entity for this room. The turn-on branch checks this is
        "off" before turning on, and the turn-off branch checks it is "on" before
        turning off. Leave empty to skip the state check (useful for rooms with
        complex multi-light logic handled in custom actions/conditions).
      default: ""
      selector:
        entity:
          domain: light

    # ========== Turn-On ==========
    turn_on_actions:
      name: Turn-on actions
      description: >
        Actions to execute when turning the light on. Can be as simple as
        calling a script (e.g., script.lighting_garage_on) or as complex as
        a multi-step sequence with choose/if blocks for theater mode, brightness
        levels, etc.
      selector:
        action: {}

    additional_detect_entities:
      name: Additional detect entities
      description: >
        Entities that trigger the turn-on branch when they transition from
        off to on. For rooms with motion sensors, door contacts, or area
        presence binary sensors. Select multiple entities if needed.

        If an entity should trigger both turn-on AND turn-off, add it to
        both this list and the "Additional clear entities" list below.

        The default (sun.sun) is a placeholder that never fires off→on.
        Replace it with binary_sensor entities for rooms that need them.
      default:
        - sun.sun
      selector:
        entity:
          multiple: true

    additional_on_condition:
      name: Additional turn-on conditions
      description: >
        Extra conditions that must be met for the light to turn on. Use the
        HA condition editor to add state checks, template conditions, time
        ranges, etc. Leave empty (default) to skip.

        The blueprint already checks these before turn-on:
        - Global toggles are on (presence, lighting, vacation mode off)
        - Room transitioned from empty/away to occupied
        - Room is not in a sleeping state
        - Primary light is currently off (if a light entity is set)
        - Sleeping child suppression is not active (if that flag is enabled)

        Use this input for room-specific logic not covered above, such as
        theater mode, dinner party mode, or checking nearby room lights.
      default: []
      selector:
        condition: {}

    require_room_unoccupied_for_sensors:
      name: Require room unoccupied for sensor turn-on
      description: >
        When enabled (default), additional detect entities will only trigger
        the turn-on branch if the room presence entity is in an unoccupied
        state (Empty, Extended Away, or Unknown). This prevents sensors from
        re-running turn-on actions and adjusting lights when someone is
        already in the room.

        Disable this for rooms where the sensor should turn on lights
        regardless of room presence state (e.g., a door contact that should
        always trigger lights when opened).
      default: true
      selector:
        boolean: {}

    check_suppress_sleeping_child:
      name: Check suppress lights for sleeping child
      description: >
        When enabled, the turn-on branch will only fire if
        input_boolean.suppress_lights_for_sleeping_child is off.
      default: false
      selector:
        boolean: {}

    suppress_when_upstairs_minimized:
      name: Suppress turn-on when upstairs lighting is minimized
      description: >
        When enabled, the turn-on branch will only fire if
        timer.briefly_minimize_upstairs_lighting is not active. Use this
        for upstairs rooms where lights should stay dim or off while the
        minimize timer is running.
      default: false
      selector:
        boolean: {}

    # ========== Turn-Off ==========
    additional_clear_entities:
      name: Additional clear entities
      description: >
        Entities that trigger the turn-off branch when they transition from
        on to off. For rooms with area presence sensors, occupancy sensors,
        or override toggles that should initiate a turn-off check.

        If an entity should trigger both turn-on AND turn-off, add it to
        both this list and the "Additional detect entities" list above.

        The default (sun.sun) is a placeholder that never fires on→off.
        Replace it with binary_sensor or input_boolean entities as needed.
      default:
        - sun.sun
      selector:
        entity:
          multiple: true

    turn_off_actions:
      name: Turn-off actions
      description: >
        Actions to execute when turning the light off (after the delay). Can
        include script calls, fan turn-offs, inline light.turn_off, etc.
      selector:
        action: {}

    additional_off_condition:
      name: Additional turn-off conditions
      description: >
        Extra conditions that must be met for the light to turn off. Use the
        HA condition editor to add state checks, template conditions, etc.
        Leave empty (default) to skip.

        The blueprint already checks these before turn-off:
        - Global toggles are on (presence, lighting, vacation mode off)
        - Room is in an unoccupied state (Unknown, Extended Away, or Empty)
        - Primary light is currently on (if a light entity is set)

        Use this input for room-specific logic not covered above, such as
        dinner party mode or area occupancy sensors.
      default: []
      selector:
        condition: {}

    delay_before_off:
      name: Delay before off (minutes)
      description: >
        Minutes to wait after the room becomes unoccupied before turning off
        the lights.
      default: 0
      selector:
        number:
          min: 0
          max: 60
          unit_of_measurement: minutes
          mode: box

    alternate_delay_condition:
      name: Alternate delay condition
      description: >
        Conditions that, when ANY are met, cause the alternate delay to be
        used instead of the normal delay. Use the HA condition editor to add
        state checks, template conditions, etc. Leave empty (default) to
        always use the normal delay.
        Examples: guest mode is on, sleep mode is on, time is after 11pm.
      default: []
      selector:
        condition: {}

    alternate_delay:
      name: Alternate delay (minutes)
      description: >
        A second delay value used when the alternate delay condition above
        is met. Set to 0 for instant off.
      default: 0
      selector:
        number:
          min: 0
          max: 60
          unit_of_measurement: minutes
          mode: box

mode: restart
max_exceeded: silent

triggers:
  - trigger: state
    entity_id: !input room_presence_entity
    id: room_presence_changes
    alias: Room presence changes
  - trigger: state
    entity_id: !input additional_detect_entities
    from: "off"
    to: "on"
    id: sensor_detected
    alias: Additional detect entity activated
  - trigger: state
    entity_id: !input additional_clear_entities
    from: "on"
    to: "off"
    id: sensor_cleared
    alias: Additional clear entity deactivated

conditions:
  - condition: state
    entity_id: input_boolean.presence_enable_automations
    state: "on"
  - condition: state
    entity_id: input_boolean.enable_lighting_automations
    state: "on"
  - condition: state
    entity_id: input_boolean.vacation_mode
    state: "off"

actions:
  - variables:
      room_presence_entity_id: !input room_presence_entity
      delay_before_off_val: !input delay_before_off
      alternate_delay_val: !input alternate_delay
      light_check: !input light_entity_to_check
      suppress_sleeping: !input check_suppress_sleeping_child
      suppress_upstairs: !input suppress_when_upstairs_minimized
      rp_mode: !input room_presence_trigger_mode
      require_unoccupied_for_sensors: !input require_room_unoccupied_for_sensors
      unoccupied_states:
        - Unknown
        - Extended Away
        - Empty
      sleeping_states:
        - Going to Sleep
        - Sleeping
        - Waking Up
      room_presence_state: "{{ states(room_presence_entity_id) }}"
      triggered_by_a_room: >-
        {{ trigger.entity_id.startswith('input_select.presence_') }}
      is_room_state_trigger_empty_to_occupied: >-
        {% if triggered_by_a_room %}
          {% set current_state = trigger.to_state.state %}
          {% set previous_state = trigger.from_state.state %}
          {% if current_state not in unoccupied_states and previous_state in unoccupied_states %}
            true
          {% else %}
            false
          {% endif %}
        {% else %}
          {% if require_unoccupied_for_sensors %}
            {{ states(room_presence_entity_id) in unoccupied_states }}
          {% else %}
            true
          {% endif %}
        {% endif %}
    alias: Define room presence variables

  - choose:
    - conditions:
      - condition: template
        value_template: >-
          {% if trigger.id == 'sensor_detected' %}
            true
          {% elif trigger.id == 'room_presence_changes' %}
            {{ rp_mode in ['both', 'detect_only'] }}
          {% else %}
            false
          {% endif %}
        alias: Trigger is a detect entity or room presence (if mode allows)
      - condition: template
        value_template: "{{ is_room_state_trigger_empty_to_occupied }}"
        alias: Room transitioned from empty to occupied
      - condition: template
        value_template: >-
          {{ states(room_presence_entity_id) not in sleeping_states }}
        alias: Room is not in a sleeping state
      - condition: template
        value_template: >-
          {{ not light_check or is_state(light_check, 'off') }}
        alias: Primary light is off (or check skipped)
      - condition: template
        value_template: >-
          {% if suppress_sleeping %}
            {{ is_state('input_boolean.suppress_lights_for_sleeping_child', 'off') }}
          {% else %}
            true
          {% endif %}
        alias: Suppress lights for sleeping child (if enabled)
      - condition: template
        value_template: >-
          {% if suppress_upstairs %}
            {{ not is_state('timer.briefly_minimize_upstairs_lighting', 'active') }}
          {% else %}
            true
          {% endif %}
        alias: Suppress turn-on when upstairs lighting is minimized (if enabled)
      - alias: Additional turn-on conditions
        condition: and
        conditions: !input additional_on_condition
      sequence: !input turn_on_actions
      alias: Turn the light on

    - conditions:
      - condition: template
        value_template: >-
          {% if trigger.id == 'sensor_cleared' %}
            true
          {% elif trigger.id == 'room_presence_changes' %}
            {{ rp_mode in ['both', 'clear_only'] }}
          {% else %}
            false
          {% endif %}
        alias: Trigger is a clear entity or room presence (if mode allows)
      - condition: template
        value_template: "{{ room_presence_state in unoccupied_states }}"
        alias: Room is unoccupied
      - condition: template
        value_template: >-
          {{ not light_check or is_state(light_check, 'on') }}
        alias: Primary light is on (or check skipped)
      - alias: Additional turn-off conditions
        condition: and
        conditions: !input additional_off_condition
      sequence:
      - choose:
        - alias: Use alternate delay
          conditions:
            - condition: or
              conditions: !input alternate_delay_condition
          sequence:
            - delay:
                hours: 0
                minutes: !input alternate_delay
                seconds: 0
              alias: Alternate delay before turning off
        default:
          - delay:
              hours: 0
              minutes: !input delay_before_off
              seconds: 0
            alias: Normal delay before turning off
      - choose: []
        default: !input turn_off_actions
      alias: Turn the light off after a delay
    alias: Turn on or off the lights
